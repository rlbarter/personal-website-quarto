<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Rebecca Barter">
<meta name="dcterms.date" content="2019-08-19">
<meta name="description" content="Purrr is the tidyverse’s answer to apply functions for iteration. It’s one of those packages that you might have heard of, but seemed too complicated to sit down and learn. Starting with map functions, and taking you on a journey that will harness the power of the list, this post will have you purrring in no time.">

<title>Learn to purrr – Rebecca Barter</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-90929425-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>


<link rel="stylesheet" href="../styles.css">
<meta name="twitter:title" content="Learn to purrr – Rebecca Barter">
<meta name="twitter:description" content="Purrr is the tidyverse’s answer to apply functions for iteration. It’s one of those packages that you might have heard of, but seemed too complicated to sit down and learn. Starting with map functions, and taking you on a journey that will harness the power of the list, this post will have you purrring in no time.">
<meta name="twitter:card" content="summary">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Rebecca Barter</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html"> 
<span class="menu-text">Blog archive</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../consulting.html"> 
<span class="menu-text">Workshops and consulting</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-books" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Books</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-books">    
        <li>
    <a class="dropdown-item" href="https://www.vdsbook.com">
 <span class="dropdown-text">Veridical Data Science</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://www.r-workshop.org">
 <span class="dropdown-text">The R Workshop</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About Rebecca</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/rlbarter"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/rlbarter"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Learn to purrr</h1>
                  <div>
        <div class="description">
          Purrr is the tidyverse’s answer to apply functions for iteration. It’s one of those packages that you might have heard of, but seemed too complicated to sit down and learn. Starting with map functions, and taking you on a journey that will harness the power of the list, this post will have you purrring in no time.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">purrr</div>
                <div class="quarto-category">tidyverse</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Rebecca Barter </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 19, 2019</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#map-functions-beyond-apply" id="toc-map-functions-beyond-apply" class="nav-link active" data-scroll-target="#map-functions-beyond-apply">Map functions: beyond apply</a>
  <ul class="collapse">
  <li><a href="#simplest-usage-repeated-looping-with-map" id="toc-simplest-usage-repeated-looping-with-map" class="nav-link" data-scroll-target="#simplest-usage-repeated-looping-with-map">Simplest usage: repeated looping with map</a></li>
  <li><a href="#the-tilde-dot-shorthand-for-functions" id="toc-the-tilde-dot-shorthand-for-functions" class="nav-link" data-scroll-target="#the-tilde-dot-shorthand-for-functions">The tilde-dot shorthand for functions</a></li>
  <li><a href="#applying-map-functions-in-a-slightly-more-interesting-context" id="toc-applying-map-functions-in-a-slightly-more-interesting-context" class="nav-link" data-scroll-target="#applying-map-functions-in-a-slightly-more-interesting-context">Applying map functions in a slightly more interesting context</a></li>
  <li><a href="#maps-with-multiple-input-objects" id="toc-maps-with-multiple-input-objects" class="nav-link" data-scroll-target="#maps-with-multiple-input-objects">Maps with multiple input objects</a></li>
  <li><a href="#list-columns-and-nested-data-frames" id="toc-list-columns-and-nested-data-frames" class="nav-link" data-scroll-target="#list-columns-and-nested-data-frames">List columns and Nested data frames</a>
  <ul class="collapse">
  <li><a href="#nesting-the-gapminder-data" id="toc-nesting-the-gapminder-data" class="nav-link" data-scroll-target="#nesting-the-gapminder-data">Nesting the gapminder data</a></li>
  </ul></li>
  <li><a href="#advanced-exercise" id="toc-advanced-exercise" class="nav-link" data-scroll-target="#advanced-exercise">Advanced exercise</a></li>
  </ul></li>
  <li><a href="#additional-purrr-functionalities-for-lists" id="toc-additional-purrr-functionalities-for-lists" class="nav-link" data-scroll-target="#additional-purrr-functionalities-for-lists">Additional purrr functionalities for lists</a>
  <ul class="collapse">
  <li><a href="#keepdiscard-select_if-for-lists" id="toc-keepdiscard-select_if-for-lists" class="nav-link" data-scroll-target="#keepdiscard-select_if-for-lists">Keep/Discard: select_if for lists</a></li>
  <li><a href="#reduce" id="toc-reduce" class="nav-link" data-scroll-target="#reduce">Reduce</a></li>
  <li><a href="#logical-statements-for-lists" id="toc-logical-statements-for-lists" class="nav-link" data-scroll-target="#logical-statements-for-lists">Logical statements for lists</a></li>
  </ul></li>
  <li><a href="#answer-to-advanced-exercise" id="toc-answer-to-advanced-exercise" class="nav-link" data-scroll-target="#answer-to-advanced-exercise">Answer to advanced exercise</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/purrr/cat_map.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Purrr is one of those tidyverse packages that you keep hearing about, and you know you should probably learn it, but you just never seem to get around to it.</p>
<p>At it’s core, purrr is all about iteration. Purrr introduces map functions (the tidyverse’s answer to base R’s apply functions, but more in line with functional programming practices) as well as some new functions for manipulating lists. To get a quick snapshot of any tidyverse package, a nice place to go is the <a href="https://rstudio.github.io/cheatsheets/purrr.pdf">cheatsheet</a>. I find these particularly useful after I’ve already got the basics of a package down, because I inevitably realise that there are a bunch of functionalities I knew nothing about.</p>
<p>Another useful resource for learning about purrr is <a href="https://jennybc.github.io/purrr-tutorial/">Jenny Bryan’s tutorial</a>. Jenny’s tutorial is fantastic, but is a lot longer than mine. This post is a lot shorter and my goal is to get you up and running with purrr very quickly.</p>
<p>While the workhorse of dplyr is the data frame, the workhorse of purrr is the list. If you aren’t familiar with lists, hopefully this will help you understand what they are:</p>
<ul>
<li><p>A <strong>vector</strong> is a way of storing many individual elements (a single number or a single character or string) of the same type together in a single object,</p></li>
<li><p>A <strong>data frame</strong> is a way of storing many vectors of the same length but possibly of different types together in a single object</p></li>
<li><p>A <strong>list</strong> is a way of storing many objects of any type (e.g.&nbsp;data frames, plots, vectors) together in a single object</p></li>
</ul>
<p>Here is an example of a list that has three elements: a single number, a vector and a data frame</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>my_first_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">my_number =</span> <span class="dv">5</span>,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">my_vector =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>),</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">my_dataframe =</span> <span class="fu">data.frame</span>(<span class="at">a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">b =</span> <span class="fu">c</span>(<span class="st">"q"</span>, <span class="st">"b"</span>, <span class="st">"z"</span>), <span class="at">c =</span> <span class="fu">c</span>(<span class="st">"bananas"</span>, <span class="st">"are"</span>, <span class="st">"so very great"</span>)))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>my_first_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre class="output"><code>$my_number
[1] 5

$my_vector
[1] "a" "b" "c"

$my_dataframe
  a b             c
1 1 q       bananas
2 2 b           are
3 3 z so very great</code></pre>
</div>
</div>
<p>Note that a data frame is actually a special case of a list where each element of the list is a vector of the same length.</p>
<section id="map-functions-beyond-apply" class="level1">
<h1>Map functions: beyond apply</h1>
<p>A <strong>map function</strong> is one that applies the same action/function to every element of an object (e.g.&nbsp;each entry of a list or a vector, or each of the columns of a data frame).</p>
<p>If you’re familiar with the base R <code>apply()</code> functions, then it turns out that you are already familiar with map functions, even if you didn’t know it!</p>
<p>The <code>apply()</code> functions are set of super useful base-R functions for iteratively performing an action across entries of a vector or list without having to write a for-loop. While there is nothing fundamentally wrong with the base R apply functions, the syntax is somewhat inconsistent across the different apply functions, and the expected type of the object they return is often ambiguous (at least it is for <code>sapply</code>…).</p>
<p>The naming convention of the map functions are such that the type of the <strong>output</strong> is specified by the term that follows the underscore in the function name.</p>
<ul>
<li><p><code>map(.x, .f)</code> is the main mapping function and returns a list</p></li>
<li><p><code>map_df(.x, .f)</code> returns a data frame</p></li>
<li><p><code>map_dbl(.x, .f)</code> returns a numeric (double) vector</p></li>
<li><p><code>map_chr(.x, .f)</code> returns a character vector</p></li>
<li><p><code>map_lgl(.x, .f)</code> returns a logical vector</p></li>
</ul>
<p>Consistent with the way of the tidyverse, the first argument of each mapping function is always the data object that you want to map over, and the second argument is always the <em>function</em> that you want to iteratively apply to each element of the input object.</p>
<p>The <strong>input</strong> object to any <code>map</code> function is always either</p>
<ul>
<li><p>a <em>vector</em> (of any type), in which case the iteration is done over the entries of the vector,</p></li>
<li><p>a <em>list</em>, in which case the iteration is performed over the elements of the list,</p></li>
<li><p>a <em>data frame</em>, in which case the iteration is performed over the columns of the data frame (which, since a data frame is a special kind of list, is technically the same as the previous point).</p></li>
</ul>
<p>Since the first argument is always the data, this means that map functions play nicely with pipes (<code>%&gt;%</code>). If you’ve never seen pipes before, they’re really useful (originally from the <code>magrittr</code> package, but also ported with the <code>dplyr</code> package and thus with the <code>tidyverse</code>). Piping allows you to string together many functions by piping an object (which itself might be the output of a function) into the first argument of the next function. If you’d like to learn more about pipes, check out my <a href="http://www.rebeccabarter.com/blog/2019-08-05_base_r_to_tidyverse/">tidyverse blog posts</a>.</p>
<p>Throughout this post I will demonstrate each of purrr’s functionalities using both a simple numeric example (to explain the concept) and the gapminder data (to show a more complex example).</p>
<section id="simplest-usage-repeated-looping-with-map" class="level2">
<h2 class="anchored" data-anchor-id="simplest-usage-repeated-looping-with-map">Simplest usage: repeated looping with map</h2>
<p>Fundamentally, maps are for iteration. In the example below I will iterate through the vector <code>c(1, 4, 7)</code> by adding 10 to each entry. This function applied to a single number, which we will call <code>.x</code>, can be defined as</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>addTen <span class="ot">&lt;-</span> <span class="cf">function</span>(.x) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(.x <span class="sc">+</span> <span class="dv">10</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>map()</code> function below iterates <code>addTen()</code> across all entries of the vector, <code>.x = c(1, 4, 7)</code>, and returns the output as a list</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(<span class="at">.x =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> addTen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 11

[[2]]
[1] 14

[[3]]
[1] 17</code></pre>
</div>
</div>
<p>Fortunately, you don’t actually need to specify the argument names</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), addTen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 11

[[2]]
[1] 14

[[3]]
[1] 17</code></pre>
</div>
</div>
<p>Note that</p>
<ul>
<li><p>the first element of the output is the result of applying the function to the first element of the input (<code>1</code>),</p></li>
<li><p>the second element of the output is the result of applying the function to the second element of the input (<code>4</code>),</p></li>
<li><p>and the third element of the output is the result of applying the function to the third element of the input (<code>7</code>).</p></li>
</ul>
<p>The following code chunks show that no matter if the input object is a vector, a list, or a data frame, <code>map()</code> always returns a list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(<span class="fu">list</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), addTen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 11

[[2]]
[1] 14

[[3]]
[1] 17</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(<span class="fu">data.frame</span>(<span class="at">a =</span> <span class="dv">1</span>, <span class="at">b =</span> <span class="dv">4</span>, <span class="at">c =</span> <span class="dv">7</span>), addTen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$a
[1] 11

$b
[1] 14

$c
[1] 17</code></pre>
</div>
</div>
<p>If we wanted the output of <code>map</code> to be some other object type, we need to use a different function. For instance to map the input to a numeric (double) vector, you can use the <code>map_dbl()</code> (“map to a double”) function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dbl</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), addTen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 11 14 17</code></pre>
</div>
</div>
<p>To map to a character vector, you can use the <code>map_chr()</code> (“map to a character”) function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_chr</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), addTen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Automatic coercion from double to character was deprecated in purrr 1.0.0.
ℹ Please use an explicit call to `as.character()` within `map_chr()` instead.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "11.000000" "14.000000" "17.000000"</code></pre>
</div>
</div>
<p>If you want to return a data frame, then you would use the <code>map_df()</code> function. However, you need to make sure that in each iteration you’re returning a data frame which has consistent column names. <code>map_df</code> will automatically bind the rows of each iteration.</p>
<p>For this example, I want to return a data frame whose columns correspond to the original number and the number plus ten.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_df</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), <span class="cf">function</span>(.x) {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">old_number =</span> .x, </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">new_number =</span> <span class="fu">addTen</span>(.x)))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  old_number new_number
1          1         11
2          4         14
3          7         17</code></pre>
</div>
</div>
<p>Note that in this case, I defined an “anonymous” function as our output for each iteration. An anonymous function is a temporary function (that you define as the function argument to the map). Here I used the argument name <code>.x</code>, but I could have used anything.</p>
<p>Another function to be aware of is <code>modify()</code>, which is just like the map functions, but always returns an object the same type as the input object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">modify</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), addTen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 11 14 17</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modify</span>(<span class="fu">list</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), addTen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 11

[[2]]
[1] 14

[[3]]
[1] 17</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modify</span>(<span class="fu">data.frame</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), addTen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  X1 X4 X7
1 11 14 17</code></pre>
</div>
</div>
<p>Modify also has a pretty useful sibling, <code>modify_if()</code>, that only applies the function to elements that satisfy a specific criteria (specified by a “predicate function”, the second argument called <code>.p</code>). For instance, the following example only modifies the third entry since it is greater than 5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modify_if</span>(<span class="at">.x =</span> <span class="fu">list</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">.p =</span> <span class="cf">function</span>(x) x <span class="sc">&gt;</span> <span class="dv">5</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">.f =</span> addTen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 1

[[2]]
[1] 4

[[3]]
[1] 17</code></pre>
</div>
</div>
</section>
<section id="the-tilde-dot-shorthand-for-functions" class="level2">
<h2 class="anchored" data-anchor-id="the-tilde-dot-shorthand-for-functions">The tilde-dot shorthand for functions</h2>
<p>To make the code more concise you can use the tilde-dot shorthand for anonymous functions (the functions that you create as arguments of other functions).</p>
<p>The notation works by replacing</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">function</span>(x) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">+</span> <span class="dv">10</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>with</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="sc">~</span>{.x <span class="sc">+</span> <span class="dv">10</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>~</code> indicates that you have started an anonymous function, and the argument of the anonymous function can be referred to using <code>.x</code> (or simply <code>.</code>). Unlike normal function arguments that can be anything that you like, the tilde-dot function argument is always <code>.x</code>.</p>
<p>Thus, instead of defining the <code>addTen()</code> function separately, we could use the tilde-dot shorthand</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dbl</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>), <span class="sc">~</span>{.x <span class="sc">+</span> <span class="dv">10</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 11 14 17</code></pre>
</div>
</div>
</section>
<section id="applying-map-functions-in-a-slightly-more-interesting-context" class="level2">
<h2 class="anchored" data-anchor-id="applying-map-functions-in-a-slightly-more-interesting-context">Applying map functions in a slightly more interesting context</h2>
<p>Throughout this tutorial, we will use the gapminder dataset that can be loaded directly if you’re connected to the internet. Each function will first be demonstrated using a simple numeric example, and then will be demonstrated using a more complex practical example based on the gapminder dataset.</p>
<p>My general workflow involves loading the original data and saving it as an object with a meaningful name and an <code>_orig</code> suffix. I then define a copy of the original dataset without the <code>_orig</code> suffix. Having an original copy of my data in my environment means that it is easy to check that my manipulations do what I expected. I will make direct data cleaning modifications to the <code>gapminder</code> data frame, but will never edit the <code>gapminder_orig</code> data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to download the data directly:</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>gapminder_orig <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"https://raw.githubusercontent.com/rlbarter/personal-website-quarto/main/blog/data/gapminder.csv"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># define a copy of the original dataset that we will clean and play with </span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>gapminder <span class="ot">&lt;-</span> gapminder_orig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The gapminder dataset has 1704 rows containing information on population, life expectancy and GDP per capita by year and country.</p>
<p>A “tidy” data frame is one where every row is a single observational unit (in this case, indexed by country and year), and every column corresponds to a variable that is measured for each observational unit (in this case, for each country and year, a measurement is made for population, continent, life expectancy and GDP). If you’d like to learn more about “tidy data”, I highly recommend reading <a href="vita.had.co.nz/papers/tidy-data.pdf">Hadley Wickham’s tidy data article</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(gapminder)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1704    6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gapminder)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      country continent year lifeExp      pop gdpPercap
1 Afghanistan      Asia 1952  28.801  8425333  779.4453
2 Afghanistan      Asia 1957  30.332  9240934  820.8530
3 Afghanistan      Asia 1962  31.997 10267083  853.1007
4 Afghanistan      Asia 1967  34.020 11537966  836.1971
5 Afghanistan      Asia 1972  36.088 13079460  739.9811
6 Afghanistan      Asia 1977  38.438 14880372  786.1134</code></pre>
</div>
</div>
<p>Since <code>gapminder</code> is a data frame, the <code>map_</code> functions will iterate over each column. An example of simple usage of the <code>map_</code> functions is to summarize each column. For instance, you can identify the type of each column by applying the <code>class()</code> function to each column. Since the output of the <code>class()</code> function is a character, we will use the <code>map_chr()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the class() function to each column</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">%&gt;%</span> <span class="fu">map_chr</span>(class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    country   continent        year     lifeExp         pop   gdpPercap 
"character" "character"   "integer"   "numeric"   "integer"   "numeric" </code></pre>
</div>
</div>
<p>I frequently do this to get a quick snapshot of each column type of a new dataset directly in the console. As a habit, I usually pipe in the data using <code>%&gt;%</code>, rather than provide it as an argument. Remember that the pipe places the object to the left of the pipe in the first argument of the function to the right.</p>
<p>Similarly, if you wanted to identify the number of distinct values in each column, you could apply the <code>n_distinct()</code> function from the dplyr package to each column. Since the output of <code>n_distinct()</code> is a numeric (a double), you might want to use the <code>map_dbl()</code> function so that the results of each iteration (the application of <code>n_distinct()</code> to each column) are concatenated into a numeric vector:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the n_distinct() function to each column</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">%&gt;%</span> <span class="fu">map_dbl</span>(n_distinct)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  country continent      year   lifeExp       pop gdpPercap 
      142         5        12      1626      1704      1704 </code></pre>
</div>
</div>
<p>If you want to do something a little more complicated, such return a few different summaries of each column in a data frame, you can use <code>map_df()</code>. When things are getting a little bit more complicated, you typically need to define an anonymous function that you want to apply to each column. Using the tilde-dot notation, the anonymous function below calculates the number of distinct entries and the type of the current column (which is accessible as <code>.x</code>), and then combines them into a two-column data frame. Once it has iterated through each of the columns, the <code>map_df</code> function combines the data frames row-wise into a single data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">%&gt;%</span> <span class="fu">map_df</span>(<span class="sc">~</span>(<span class="fu">data.frame</span>(<span class="at">n_distinct =</span> <span class="fu">n_distinct</span>(.x),</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">class =</span> <span class="fu">class</span>(.x))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  n_distinct     class
1        142 character
2          5 character
3         12   integer
4       1626   numeric
5       1704   integer
6       1704   numeric</code></pre>
</div>
</div>
<p>Note that we’ve lost the variable names! The variable names correspond to the names of the objects over which we are iterating (in this case, the column names), and these are not automatically included as a column in the output data frame. You can tell <code>map_df()</code> to include them using the <code>.id</code> argument of <code>map_df()</code>. This will automatically take the name of the element being iterated over and include it in the column corresponding to whatever you set <code>.id</code> to.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">%&gt;%</span> <span class="fu">map_df</span>(<span class="sc">~</span>(<span class="fu">data.frame</span>(<span class="at">n_distinct =</span> <span class="fu">n_distinct</span>(.x),</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">class =</span> <span class="fu">class</span>(.x))),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">.id =</span> <span class="st">"variable"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   variable n_distinct     class
1   country        142 character
2 continent          5 character
3      year         12   integer
4   lifeExp       1626   numeric
5       pop       1704   integer
6 gdpPercap       1704   numeric</code></pre>
</div>
</div>
<p>If you’re having trouble thinking through these map actions, I recommend that you first figure out what the code would be to do what you want for a single element, and then paste it into the <code>map_df()</code> function (a nice trick I saw Hadley Wickham used a few years ago when he presented on purrr at RLadies SF).</p>
<p>For instance, since the first element of the gapminder data frame is the first column, let’s define <code>.x</code> in our environment to be this first column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># take the first element of the gapminder data</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>.x <span class="ot">&lt;-</span> gapminder <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="dv">1</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># look at the first 6 rows</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(.x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Afghanistan" "Afghanistan" "Afghanistan" "Afghanistan" "Afghanistan"
[6] "Afghanistan"</code></pre>
</div>
</div>
<p>Then, you can create a data frame for this column that contains the number of distinct entries, and the class of the column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">n_distinct =</span> <span class="fu">n_distinct</span>(.x),</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">class =</span> <span class="fu">class</span>(.x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  n_distinct     class
1        142 character</code></pre>
</div>
</div>
<p>Since this has done what was expected want for the first column, you can paste this code into the map function using the tilde-dot shorthand.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">%&gt;%</span> <span class="fu">map_df</span>(<span class="sc">~</span>(<span class="fu">data.frame</span>(<span class="at">n_distinct =</span> <span class="fu">n_distinct</span>(.x),</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">class =</span> <span class="fu">class</span>(.x))),</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">.id =</span> <span class="st">"variable"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   variable n_distinct     class
1   country        142 character
2 continent          5 character
3      year         12   integer
4   lifeExp       1626   numeric
5       pop       1704   integer
6 gdpPercap       1704   numeric</code></pre>
</div>
</div>
<p><code>map_df()</code> is definitely one of the most powerful functions of <code>purrr</code> in my opinion, and is probably the one that I use most.</p>
</section>
<section id="maps-with-multiple-input-objects" class="level2">
<h2 class="anchored" data-anchor-id="maps-with-multiple-input-objects">Maps with multiple input objects</h2>
<p>After gaining a basic understanding of purrr’s map functions, you can start to do some fancier stuff. For instance, what if you want to perform a map that iterates through two objects. The code below uses map functions to create a <em>list of plots</em> that compare life expectancy and GDP per capita for each continent/year combination.</p>
<p>The map function that maps over two objects instead of 1 is called <code>map2()</code>. The first two arguments are the two objects you want to iterate over, and the third is the function (with two arguments, one for each object).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map2</span>(<span class="at">.x =</span> object1, <span class="co"># the first object to iterate over</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">.y =</span> object2, <span class="co"># the second object to iterate over</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">.f =</span> <span class="fu">plotFunction</span>(.x, .y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, you need to define a vector (or list) of continents and a paired vector (or list) of years that you want to iterate through. Note that in our continent/year example</p>
<ul>
<li><p>the <em>first iteration</em> will correspond to the <em>first continent</em> in the continent vector and the <em>first year</em> in the year vector,</p></li>
<li><p>the <em>second iteration</em> will correspond to the <em>second continent</em> in the continent vector and the <em>second year</em> in the year vector.</p></li>
</ul>
<p>This might seem obvious, but it is a natural instinct to incorrectly assume that <code>map2()</code> will automatically perform the action on <em>all</em> combinations that can be made from the two vectors. For instance if you have a continent vector <code>.x = c("Americas", "Asia")</code> and a year vector <code>.y = c(1952, 2007)</code>, then you might assume that <code>map2</code> will iterate over the Americas for 1952 and for 2007, and then Asia for 1952 and 2007. It won’t though. The iteration will actually be first the Americas for 1952 only, and then Asia for 2007 only.</p>
<p>First, let’s get our vectors of continents and years, starting by obtaining all distinct combinations of continents and years that appear in the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>continent_year <span class="ot">&lt;-</span> gapminder <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(continent, year)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>continent_year</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   continent year
1       Asia 1952
2       Asia 1957
3       Asia 1962
4       Asia 1967
5       Asia 1972
6       Asia 1977
7       Asia 1982
8       Asia 1987
9       Asia 1992
10      Asia 1997
11      Asia 2002
12      Asia 2007
13    Europe 1952
14    Europe 1957
15    Europe 1962
16    Europe 1967
17    Europe 1972
18    Europe 1977
19    Europe 1982
20    Europe 1987
21    Europe 1992
22    Europe 1997
23    Europe 2002
24    Europe 2007
25    Africa 1952
26    Africa 1957
27    Africa 1962
28    Africa 1967
29    Africa 1972
30    Africa 1977
31    Africa 1982
32    Africa 1987
33    Africa 1992
34    Africa 1997
35    Africa 2002
36    Africa 2007
37  Americas 1952
38  Americas 1957
39  Americas 1962
40  Americas 1967
41  Americas 1972
42  Americas 1977
43  Americas 1982
44  Americas 1987
45  Americas 1992
46  Americas 1997
47  Americas 2002
48  Americas 2007
49   Oceania 1952
50   Oceania 1957
51   Oceania 1962
52   Oceania 1967
53   Oceania 1972
54   Oceania 1977
55   Oceania 1982
56   Oceania 1987
57   Oceania 1992
58   Oceania 1997
59   Oceania 2002
60   Oceania 2007</code></pre>
</div>
</div>
<p>Then extracting the continent and year pairs as separate vectors</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract the continent and year pairs as separate vectors</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>continents <span class="ot">&lt;-</span> continent_year <span class="sc">%&gt;%</span> <span class="fu">pull</span>(continent) <span class="sc">%&gt;%</span> as.character</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> continent_year <span class="sc">%&gt;%</span> <span class="fu">pull</span>(year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you want to use tilde-dot short-hand, the anonymous arguments will be <code>.x</code> for the first object being iterated over, and <code>.y</code> for the second object being iterated over.</p>
<p>Before jumping straight into the map function, it’s a good idea to first figure out what the code will be for just first iteration (the first continent and the first year, which happen to be Asia in 1952).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># try to figure out the code for the first example</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>.x <span class="ot">&lt;-</span> continents[<span class="dv">1</span>]</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>.y <span class="ot">&lt;-</span> years[<span class="dv">1</span>]</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># make a scatterplot of GDP vs life expectancy in all Asian countries for 1952</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">%&gt;%</span> </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(continent <span class="sc">==</span> .x,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>         year <span class="sc">==</span> .y) <span class="sc">%&gt;%</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> gdpPercap, <span class="at">y =</span> lifeExp)) <span class="sc">+</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(glue<span class="sc">::</span><span class="fu">glue</span>(.x, <span class="st">" "</span>, .y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2019-08-19_purrr_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This seems to have worked. So you can then copy-and-paste the code into the <code>map2</code> function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>plot_list <span class="ot">&lt;-</span> <span class="fu">map2</span>(<span class="at">.x =</span> continents, </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.y =</span> years, </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>                    gapminder <span class="sc">%&gt;%</span> </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">filter</span>(continent <span class="sc">==</span> .x,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>                             year <span class="sc">==</span> .y) <span class="sc">%&gt;%</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> gdpPercap, <span class="at">y =</span> lifeExp)) <span class="sc">+</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">ggtitle</span>(glue<span class="sc">::</span><span class="fu">glue</span>(.x, <span class="st">" "</span>, .y))</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>                  })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And you can look at a few of the entries of the list to see that they make sense</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>plot_list[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2019-08-19_purrr_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>plot_list[[<span class="dv">22</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2019-08-19_purrr_files/figure-html/unnamed-chunk-32-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><code>pmap()</code> allows you to iterate over an arbitrary number of objects (i.e.&nbsp;more than two).</p>
</section>
<section id="list-columns-and-nested-data-frames" class="level2">
<h2 class="anchored" data-anchor-id="list-columns-and-nested-data-frames">List columns and Nested data frames</h2>
<p>Tibbles are tidyverse data frames. Some crazy stuff starts happening when you learn that tibble columns can be lists (as opposed to vectors, which is what they usually are). This is where the difference between tibbles and data frames becomes real.</p>
<p>For instance, a tibble can be “nested” where the tibble is essentially split into separate data frames based on a grouping variable, and these separate data frames are stored as entries of a list (that is then stored in the <code>data</code> column of the data frame).</p>
<p>Below I nest the gapminder data by continent.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>gapminder_nested <span class="ot">&lt;-</span> gapminder <span class="sc">%&gt;%</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(continent) <span class="sc">%&gt;%</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>()</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>gapminder_nested</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
# Groups:   continent [5]
  continent data              
  &lt;chr&gt;     &lt;list&gt;            
1 Asia      &lt;tibble [396 × 5]&gt;
2 Europe    &lt;tibble [360 × 5]&gt;
3 Africa    &lt;tibble [624 × 5]&gt;
4 Americas  &lt;tibble [300 × 5]&gt;
5 Oceania   &lt;tibble [24 × 5]&gt; </code></pre>
</div>
</div>
<p>The first column is the variable that we grouped by, <code>continent</code>, and the second column is the rest of the data frame corresponding to that group (as if you had filtered the data frame to the specific continent). To see this, the code below shows that the first entry in the <code>data</code> column corresponds to the entire gapminder dataset for Asia.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>gapminder_nested<span class="sc">$</span>data[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 396 × 5
   country      year lifeExp      pop gdpPercap
   &lt;chr&gt;       &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
 1 Afghanistan  1952    28.8  8425333      779.
 2 Afghanistan  1957    30.3  9240934      821.
 3 Afghanistan  1962    32.0 10267083      853.
 4 Afghanistan  1967    34.0 11537966      836.
 5 Afghanistan  1972    36.1 13079460      740.
 6 Afghanistan  1977    38.4 14880372      786.
 7 Afghanistan  1982    39.9 12881816      978.
 8 Afghanistan  1987    40.8 13867957      852.
 9 Afghanistan  1992    41.7 16317921      649.
10 Afghanistan  1997    41.8 22227415      635.
# ℹ 386 more rows</code></pre>
</div>
</div>
<p>Using dplyr <code>pluck()</code> function, this can be written as</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>gapminder_nested <span class="sc">%&gt;%</span> </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract the first entry from the data column</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">"data"</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 396 × 5
   country      year lifeExp      pop gdpPercap
   &lt;chr&gt;       &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
 1 Afghanistan  1952    28.8  8425333      779.
 2 Afghanistan  1957    30.3  9240934      821.
 3 Afghanistan  1962    32.0 10267083      853.
 4 Afghanistan  1967    34.0 11537966      836.
 5 Afghanistan  1972    36.1 13079460      740.
 6 Afghanistan  1977    38.4 14880372      786.
 7 Afghanistan  1982    39.9 12881816      978.
 8 Afghanistan  1987    40.8 13867957      852.
 9 Afghanistan  1992    41.7 16317921      649.
10 Afghanistan  1997    41.8 22227415      635.
# ℹ 386 more rows</code></pre>
</div>
</div>
<p>Similarly, the 5th entry in the <code>data</code> column corresponds to the entire gapminder dataset for Oceania.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>gapminder_nested <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"data"</span>, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   country    year lifeExp      pop gdpPercap
   &lt;chr&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
 1 Australia  1952    69.1  8691212    10040.
 2 Australia  1957    70.3  9712569    10950.
 3 Australia  1962    70.9 10794968    12217.
 4 Australia  1967    71.1 11872264    14526.
 5 Australia  1972    71.9 13177000    16789.
 6 Australia  1977    73.5 14074100    18334.
 7 Australia  1982    74.7 15184200    19477.
 8 Australia  1987    76.3 16257249    21889.
 9 Australia  1992    77.6 17481977    23425.
10 Australia  1997    78.8 18565243    26998.
# ℹ 14 more rows</code></pre>
</div>
</div>
<p>You might be asking at this point <em>why</em> you would ever want to nest your data frame? It just doesn’t seem like that useful a thing to do… until you realise that you now have the power to use dplyr manipulations on more complex objects that can be stored in a list.</p>
<p>However, since actions such as <code>mutate()</code> are applied directly to the entire column (which is usually a vector, so is fine), we run into issues when we try to mutate a list. For instance, since columns are usually vectors, normal vectorized functions work just fine on them</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">vec_col =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">vec_sum =</span> <span class="fu">sum</span>(vec_col))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   vec_col vec_sum
     &lt;int&gt;   &lt;int&gt;
 1       1      55
 2       2      55
 3       3      55
 4       4      55
 5       5      55
 6       6      55
 7       7      55
 8       8      55
 9       9      55
10      10      55</code></pre>
</div>
</div>
<p>but when the column is a list, vectorized functions don’t know what to do with them, and we get an error that says <code>Error in sum(x) : invalid 'type' (list) of argument</code>. Try</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">list_col =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">7</span>), </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>                       <span class="dv">5</span>, </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">11</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">list_sum =</span> <span class="fu">sum</span>(list_col))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To apply mutate functions to a list-column, you need to wrap the function you want to apply in a map function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">list_col =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">7</span>), </span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>                       <span class="dv">5</span>, </span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">11</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">list_sum =</span> <span class="fu">map</span>(list_col, sum))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  list_col  list_sum 
  &lt;list&gt;    &lt;list&gt;   
1 &lt;dbl [3]&gt; &lt;dbl [1]&gt;
2 &lt;dbl [1]&gt; &lt;dbl [1]&gt;
3 &lt;dbl [3]&gt; &lt;dbl [1]&gt;</code></pre>
</div>
</div>
<p>Since <code>map()</code> returns a list itself, the <code>list_sum</code> column is thus itself a list</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">list_col =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">7</span>), </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>                       <span class="dv">5</span>, </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">11</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">list_sum =</span> <span class="fu">map</span>(list_col, sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(list_sum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 13

[[2]]
[1] 5

[[3]]
[1] 31</code></pre>
</div>
</div>
<p>What could we do if we wanted it to be a vector? We could use the <code>map_dbl()</code> function instead!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">list_col =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">7</span>), </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>                       <span class="dv">5</span>, </span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">11</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">list_sum =</span> <span class="fu">map_dbl</span>(list_col, sum))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  list_col  list_sum
  &lt;list&gt;       &lt;dbl&gt;
1 &lt;dbl [3]&gt;       13
2 &lt;dbl [1]&gt;        5
3 &lt;dbl [3]&gt;       31</code></pre>
</div>
</div>
<section id="nesting-the-gapminder-data" class="level3">
<h3 class="anchored" data-anchor-id="nesting-the-gapminder-data">Nesting the gapminder data</h3>
<p>Let’s return to the nested gapminder dataset. I want to calculate the average life expectancy within each continent and add it as a new column using <code>mutate()</code>. Based on the example above, can you explain why the following code doesn’t work?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>gapminder_nested <span class="sc">%&gt;%</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_lifeExp =</span> <span class="fu">mean</span>(data<span class="sc">$</span>lifeExp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I was hoping that this code would extract the <code>lifeExp</code> column from each data frame. But I’m applying the mutate to the <code>data</code> column, which itself doesn’t have an entry called <code>lifeExp</code> since it’s a <em>list</em> of data frames. How could I get access to the <code>lifeExp</code> column of the data frames stored in the <code>data</code> list? Using a <code>map</code> function of course!</p>
<p>Think of an individual data frame as <code>.x</code>. Again, I will first figure out the code for calculating the mean life expectancy for the first entry of the column. The following code defines <code>.x</code> to be the first entry of the <code>data</code> column (this is the data frame for Asia).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the first entry of the "data" column</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>.x <span class="ot">&lt;-</span> gapminder_nested <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"data"</span>, <span class="dv">1</span>)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 396 × 5
   country      year lifeExp      pop gdpPercap
   &lt;chr&gt;       &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
 1 Afghanistan  1952    28.8  8425333      779.
 2 Afghanistan  1957    30.3  9240934      821.
 3 Afghanistan  1962    32.0 10267083      853.
 4 Afghanistan  1967    34.0 11537966      836.
 5 Afghanistan  1972    36.1 13079460      740.
 6 Afghanistan  1977    38.4 14880372      786.
 7 Afghanistan  1982    39.9 12881816      978.
 8 Afghanistan  1987    40.8 13867957      852.
 9 Afghanistan  1992    41.7 16317921      649.
10 Afghanistan  1997    41.8 22227415      635.
# ℹ 386 more rows</code></pre>
</div>
</div>
<p>Then to calculate the average life expectancy for Asia, I could write</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(.x<span class="sc">$</span>lifeExp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 60.0649</code></pre>
</div>
</div>
<p>So copy-pasting this into the tilde-dot anonymous function argument of the <code>map_dbl()</code> function within <code>mutate()</code>, I get what I wanted!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>gapminder_nested <span class="sc">%&gt;%</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_lifeExp =</span> <span class="fu">map_dbl</span>(data, <span class="sc">~</span>{<span class="fu">mean</span>(.x<span class="sc">$</span>lifeExp)}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
# Groups:   continent [5]
  continent data               avg_lifeExp
  &lt;chr&gt;     &lt;list&gt;                   &lt;dbl&gt;
1 Asia      &lt;tibble [396 × 5]&gt;        60.1
2 Europe    &lt;tibble [360 × 5]&gt;        71.9
3 Africa    &lt;tibble [624 × 5]&gt;        48.9
4 Americas  &lt;tibble [300 × 5]&gt;        64.7
5 Oceania   &lt;tibble [24 × 5]&gt;         74.3</code></pre>
</div>
</div>
<p>This code iterates through the data frames stored in the <code>data</code> column, returns the average life expectancy for each data frame, and concatonates the results into a numeric vector (which is then stored as a column called <code>avg_lifeExp</code>).</p>
<p>I hear what you’re saying… this is something that we could have done a lot more easily using standard dplyr commands (such as <code>summarise()</code>). True, but hopefully it helped you understand why you need to wrap mutate functions inside map functions when applying them to list columns.</p>
<p>Even if this example was less than inspiring, I promise the next example will knock your socks off!</p>
<p>The next exampe will demonstrate how to fit a model separately for each continent, and evaluate it, all within a single tibble. First, I will fit a linear model for each continent and store it as a list-column. If the data frame for a single continent is <code>.x</code>, then the model I want to fit is <code>lm(lifeExp ~ pop + gdpPercap + year, data = .x)</code> (check for yourself that this does what you expect). So I can copy-past this command into the <code>map()</code> function within the <code>mutate()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit a model separately for each continent</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>gapminder_nested <span class="ot">&lt;-</span> gapminder_nested <span class="sc">%&gt;%</span> </span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lm_obj =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(lifeExp <span class="sc">~</span> pop <span class="sc">+</span> gdpPercap <span class="sc">+</span> year, <span class="at">data =</span> .x)))</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>gapminder_nested</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
# Groups:   continent [5]
  continent data               lm_obj
  &lt;chr&gt;     &lt;list&gt;             &lt;list&gt;
1 Asia      &lt;tibble [396 × 5]&gt; &lt;lm&gt;  
2 Europe    &lt;tibble [360 × 5]&gt; &lt;lm&gt;  
3 Africa    &lt;tibble [624 × 5]&gt; &lt;lm&gt;  
4 Americas  &lt;tibble [300 × 5]&gt; &lt;lm&gt;  
5 Oceania   &lt;tibble [24 × 5]&gt;  &lt;lm&gt;  </code></pre>
</div>
</div>
<p>Where the first linear model (for Asia) is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>gapminder_nested <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"lm_obj"</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = lifeExp ~ pop + gdpPercap + year, data = .x)

Coefficients:
(Intercept)          pop    gdpPercap         year  
 -7.833e+02    4.228e-11    2.510e-04    4.251e-01  </code></pre>
</div>
</div>
<p>I can then predict the response for the data stored in the <code>data</code> column using the corresponding linear model. So I have two objects I want to iterate over: the data and the linear model object. This means I want to use <code>map2()</code>. When things get a little more complicated I like to have multiple function arguments, so I’m going to use a full anonymous function rather than the tilde-dot shorthand.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># predict the response for each continent</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>gapminder_nested <span class="ot">&lt;-</span> gapminder_nested <span class="sc">%&gt;%</span> </span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred =</span> <span class="fu">map2</span>(lm_obj, data, <span class="cf">function</span>(.lm, .data) <span class="fu">predict</span>(.lm, .data)))</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>gapminder_nested</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
# Groups:   continent [5]
  continent data               lm_obj pred       
  &lt;chr&gt;     &lt;list&gt;             &lt;list&gt; &lt;list&gt;     
1 Asia      &lt;tibble [396 × 5]&gt; &lt;lm&gt;   &lt;dbl [396]&gt;
2 Europe    &lt;tibble [360 × 5]&gt; &lt;lm&gt;   &lt;dbl [360]&gt;
3 Africa    &lt;tibble [624 × 5]&gt; &lt;lm&gt;   &lt;dbl [624]&gt;
4 Americas  &lt;tibble [300 × 5]&gt; &lt;lm&gt;   &lt;dbl [300]&gt;
5 Oceania   &lt;tibble [24 × 5]&gt;  &lt;lm&gt;   &lt;dbl [24]&gt; </code></pre>
</div>
</div>
<p>And I can then calculate the correlation between the predicted response and the true response, this time using the <code>map2()_dbl</code> function since I want the output the be a numeric vector rather than a list of single elements.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the correlation between observed and predicted response for each continent</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>gapminder_nested <span class="ot">&lt;-</span> gapminder_nested <span class="sc">%&gt;%</span> </span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cor =</span> <span class="fu">map2_dbl</span>(pred, data, <span class="cf">function</span>(.pred, .data) <span class="fu">cor</span>(.pred, .data<span class="sc">$</span>lifeExp)))</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>gapminder_nested</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
# Groups:   continent [5]
  continent data               lm_obj pred          cor
  &lt;chr&gt;     &lt;list&gt;             &lt;list&gt; &lt;list&gt;      &lt;dbl&gt;
1 Asia      &lt;tibble [396 × 5]&gt; &lt;lm&gt;   &lt;dbl [396]&gt; 0.723
2 Europe    &lt;tibble [360 × 5]&gt; &lt;lm&gt;   &lt;dbl [360]&gt; 0.834
3 Africa    &lt;tibble [624 × 5]&gt; &lt;lm&gt;   &lt;dbl [624]&gt; 0.645
4 Americas  &lt;tibble [300 × 5]&gt; &lt;lm&gt;   &lt;dbl [300]&gt; 0.779
5 Oceania   &lt;tibble [24 × 5]&gt;  &lt;lm&gt;   &lt;dbl [24]&gt;  0.987</code></pre>
</div>
</div>
<p>Holy guacamole, that is so awesome!</p>
</section>
</section>
<section id="advanced-exercise" class="level2">
<h2 class="anchored" data-anchor-id="advanced-exercise">Advanced exercise</h2>
<p>The goal of this exercise is to fit a separate linear model for each continent without splitting up the data. Create the following data frame that has the continent, each term in the model for the continent, its linear model coefficient estimate, and standard error.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 6
   continent term         estimate std.error statistic  p.value
   &lt;chr&gt;     &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 Asia      (Intercept) -7.83e+ 2   4.83e+1  -16.2    1.22e-45
 2 Asia      pop          4.23e-11   2.04e-9    0.0207 9.83e- 1
 3 Asia      year         4.25e- 1   2.44e-2   17.4    1.13e-50
 4 Asia      gdpPercap    2.51e- 4   3.01e-5    8.34   1.31e-15
 5 Europe    (Intercept) -1.61e+ 2   2.28e+1   -7.09   7.44e-12
 6 Europe    pop         -8.18e- 9   7.80e-9   -1.05   2.95e- 1
 7 Europe    year         1.16e- 1   1.16e-2    9.96   8.88e-21
 8 Europe    gdpPercap    3.25e- 4   2.15e-5   15.2    2.21e-40
 9 Africa    (Intercept) -4.70e+ 2   3.39e+1  -13.9    2.17e-38
10 Africa    pop         -3.68e- 9   1.89e-8   -0.195  8.45e- 1
11 Africa    year         2.61e- 1   1.71e-2   15.2    1.07e-44
12 Africa    gdpPercap    1.12e- 3   1.01e-4   11.1    2.46e-26
13 Americas  (Intercept) -5.33e+ 2   4.10e+1  -13.0    6.40e-31
14 Americas  pop         -2.15e- 8   8.62e-9   -2.49   1.32e- 2
15 Americas  year         3.00e- 1   2.08e-2   14.4    3.79e-36
16 Americas  gdpPercap    6.75e- 4   7.15e-5    9.44   1.13e-18
17 Oceania   (Intercept) -2.10e+ 2   5.12e+1   -4.10   5.61e- 4
18 Oceania   pop          8.37e- 9   3.34e-8    0.251  8.05e- 1
19 Oceania   year         1.42e- 1   2.65e-2    5.34   3.19e- 5
20 Oceania   gdpPercap    2.03e- 4   8.47e-5    2.39   2.66e- 2</code></pre>
</div>
</div>
<p>Hint: starting from the <code>gapminder</code> dataset, use <code>group_by()</code> and <code>nest()</code> to nest by continent, use a mutate together with <code>map</code> to fit a linear model for each continent, use another mutate with <code>broom::tidy()</code> to get a data frame of model coefficients for each model, and a <code>transmute</code> to get just the columns you want, followed by an <code>unnest()</code> to re-expand the nested tibble.</p>
<p>The solution code is at the end of this post.</p>
<p>If you want to stop here, you will already know more than most purrr users. The remainder of this blog post involves little-used features of purrr for manipulating lists.</p>
</section>
</section>
<section id="additional-purrr-functionalities-for-lists" class="level1">
<h1>Additional purrr functionalities for lists</h1>
<p>To demonstrate how to use purrr to manipulate lists, we will split the gapminder dataset into a <em>list of data frames</em> (which is kind of like the converse of a data frame containing a list-column). To make sure it’s easy to follow, we will only keep 5 rows from each continent.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">23489</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>gapminder_list <span class="ot">&lt;-</span> gapminder <span class="sc">%&gt;%</span> <span class="fu">split</span>(gapminder<span class="sc">$</span>continent) <span class="sc">%&gt;%</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span><span class="fu">sample_n</span>(., <span class="dv">5</span>))</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>gapminder_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$Africa
            country continent year lifeExp      pop gdpPercap
1            Gambia    Africa 1967  35.857   439593  734.7829
2      Sierra Leone    Africa 1967  34.113  2662190 1206.0435
3           Namibia    Africa 1997  58.909  1774766 3899.5243
4 Equatorial Guinea    Africa 1992  47.545   387838 1132.0550
5     Cote d'Ivoire    Africa 2002  46.832 16252726 1648.8008

$Americas
             country continent year lifeExp     pop gdpPercap
1 Dominican Republic  Americas 1997  69.957 7992357  3614.101
2        Puerto Rico  Americas 1987  74.630 3444468 12281.342
3           Honduras  Americas 1992  66.399 5077347  3081.695
4            Uruguay  Americas 2007  76.384 3447496 10611.463
5         Costa Rica  Americas 1962  62.842 1345187  3460.937

$Asia
      country continent year lifeExp       pop gdpPercap
1     Lebanon      Asia 1967  63.870   2186894 6006.9830
2       Nepal      Asia 1962  39.393  10332057  652.3969
3 Yemen, Rep.      Asia 1992  55.599  13367997 1879.4967
4       India      Asia 1972  50.651 567000000  724.0325
5    Cambodia      Asia 1952  39.417   4693836  368.4693

$Europe
         country continent year lifeExp      pop gdpPercap
1 United Kingdom    Europe 2002  78.471 59912431  29479.00
2         Greece    Europe 1997  77.869 10502372  18747.70
3        Belgium    Europe 2002  78.320 10311970  30485.88
4        Croatia    Europe 2002  74.876  4481020  11628.39
5    Netherlands    Europe 1967  73.820 12596822  15363.25

$Oceania
      country continent year lifeExp      pop gdpPercap
1   Australia   Oceania 1982  74.740 15184200  19477.01
2 New Zealand   Oceania 1997  77.550  3676187  21050.41
3 New Zealand   Oceania 2007  80.204  4115771  25185.01
4   Australia   Oceania 2007  81.235 20434176  34435.37
5 New Zealand   Oceania 1952  69.390  1994794  10556.58</code></pre>
</div>
</div>
<section id="keepdiscard-select_if-for-lists" class="level2">
<h2 class="anchored" data-anchor-id="keepdiscard-select_if-for-lists">Keep/Discard: select_if for lists</h2>
<p><code>keep()</code> only keeps elements of a list that satisfy a given condition, much like <code>select_if()</code> selects columns of a data frame that satisfy a given condition.</p>
<p>The following code only keeps the gapminder continent data frames (the elements of the list) that have an average (among the sample of 5 rows) life expectancy of at least 70.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>gapminder_list <span class="sc">%&gt;%</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">keep</span>(<span class="sc">~</span>{<span class="fu">mean</span>(.x<span class="sc">$</span>lifeExp) <span class="sc">&gt;</span> <span class="dv">70</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$Americas
             country continent year lifeExp     pop gdpPercap
1 Dominican Republic  Americas 1997  69.957 7992357  3614.101
2        Puerto Rico  Americas 1987  74.630 3444468 12281.342
3           Honduras  Americas 1992  66.399 5077347  3081.695
4            Uruguay  Americas 2007  76.384 3447496 10611.463
5         Costa Rica  Americas 1962  62.842 1345187  3460.937

$Europe
         country continent year lifeExp      pop gdpPercap
1 United Kingdom    Europe 2002  78.471 59912431  29479.00
2         Greece    Europe 1997  77.869 10502372  18747.70
3        Belgium    Europe 2002  78.320 10311970  30485.88
4        Croatia    Europe 2002  74.876  4481020  11628.39
5    Netherlands    Europe 1967  73.820 12596822  15363.25

$Oceania
      country continent year lifeExp      pop gdpPercap
1   Australia   Oceania 1982  74.740 15184200  19477.01
2 New Zealand   Oceania 1997  77.550  3676187  21050.41
3 New Zealand   Oceania 2007  80.204  4115771  25185.01
4   Australia   Oceania 2007  81.235 20434176  34435.37
5 New Zealand   Oceania 1952  69.390  1994794  10556.58</code></pre>
</div>
</div>
<p><code>discard()</code> does the opposite of <code>keep()</code>: it discards any elements that satisfy your logical condition.</p>
</section>
<section id="reduce" class="level2">
<h2 class="anchored" data-anchor-id="reduce">Reduce</h2>
<p><code>reduce()</code> is designed to combine (reduces) all of the elements of a list into a single object by iteratively applying a binary function (a function that takes two inputs).</p>
<p>For instance, applying a reduce function to add up all of the elements of the vector <code>c(1, 2, 3)</code> is like doing <code>sum(sum(1, 2), 3)</code>: first it applies <code>sum</code> to <code>1</code> and <code>2</code>, then it applies <code>sum</code> again to the output of <code>sum(1, 2)</code> and <code>3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), sum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
</div>
<p><code>accumulate()</code> also returns the intermediate values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accumulate</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), sum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 3 6</code></pre>
</div>
</div>
<p>An example of when <code>reduce()</code> might come in handy is when you want to perform many <code>left_join()</code>s in a row, or to do repeated <code>rbinds()</code> (e.g.&nbsp;to bind the rows of the list back together into a single data frame)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>gapminder_list <span class="sc">%&gt;%</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(rbind)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              country continent year lifeExp       pop  gdpPercap
1              Gambia    Africa 1967  35.857    439593   734.7829
2        Sierra Leone    Africa 1967  34.113   2662190  1206.0435
3             Namibia    Africa 1997  58.909   1774766  3899.5243
4   Equatorial Guinea    Africa 1992  47.545    387838  1132.0550
5       Cote d'Ivoire    Africa 2002  46.832  16252726  1648.8008
6  Dominican Republic  Americas 1997  69.957   7992357  3614.1013
7         Puerto Rico  Americas 1987  74.630   3444468 12281.3419
8            Honduras  Americas 1992  66.399   5077347  3081.6946
9             Uruguay  Americas 2007  76.384   3447496 10611.4630
10         Costa Rica  Americas 1962  62.842   1345187  3460.9370
11            Lebanon      Asia 1967  63.870   2186894  6006.9830
12              Nepal      Asia 1962  39.393  10332057   652.3969
13        Yemen, Rep.      Asia 1992  55.599  13367997  1879.4967
14              India      Asia 1972  50.651 567000000   724.0325
15           Cambodia      Asia 1952  39.417   4693836   368.4693
16     United Kingdom    Europe 2002  78.471  59912431 29478.9992
17             Greece    Europe 1997  77.869  10502372 18747.6981
18            Belgium    Europe 2002  78.320  10311970 30485.8838
19            Croatia    Europe 2002  74.876   4481020 11628.3890
20        Netherlands    Europe 1967  73.820  12596822 15363.2514
21          Australia   Oceania 1982  74.740  15184200 19477.0093
22        New Zealand   Oceania 1997  77.550   3676187 21050.4138
23        New Zealand   Oceania 2007  80.204   4115771 25185.0091
24          Australia   Oceania 2007  81.235  20434176 34435.3674
25        New Zealand   Oceania 1952  69.390   1994794 10556.5757</code></pre>
</div>
</div>
</section>
<section id="logical-statements-for-lists" class="level2">
<h2 class="anchored" data-anchor-id="logical-statements-for-lists">Logical statements for lists</h2>
<p>Asking logical questions of a list can be done using <code>every()</code> and <code>some()</code>. For instance to ask whether <em>every</em> continent has average life expectancy greater than 70, you can use <code>every()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>gapminder_list <span class="sc">%&gt;%</span> <span class="fu">every</span>(<span class="sc">~</span>{<span class="fu">mean</span>(.x<span class="sc">$</span>life) <span class="sc">&gt;</span> <span class="dv">70</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<p>To ask whether <em>some</em> continents have average life expectancy greater than 70, you can use <code>some()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>gapminder_list <span class="sc">%&gt;%</span> <span class="fu">some</span>(<span class="sc">~</span>{<span class="fu">mean</span>(.x<span class="sc">$</span>life) <span class="sc">&gt;</span> <span class="dv">70</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>An equivalent of <code>%in%</code> for lists is <code>has_element()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="dv">1</span>, <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">1</span>), <span class="st">"a"</span>) <span class="sc">%&gt;%</span> <span class="fu">has_element</span>(<span class="st">"a"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Most of these functions also work on vectors.</p>
<p>Now go forth and purrr!</p>
</section>
</section>
<section id="answer-to-advanced-exercise" class="level1">
<h1>Answer to advanced exercise</h1>
<p>The following code produces the table from the exercise above</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">%&gt;%</span> </span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(continent) <span class="sc">%&gt;%</span> </span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">%&gt;%</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lm_obj =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(lifeExp <span class="sc">~</span> pop <span class="sc">+</span> year <span class="sc">+</span> gdpPercap, <span class="at">data =</span> .))) <span class="sc">%&gt;%</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lm_tidy =</span> <span class="fu">map</span>(lm_obj, broom<span class="sc">::</span>tidy)) <span class="sc">%&gt;%</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(continent, lm_tidy) <span class="sc">%&gt;%</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(lm_tidy))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 6
   continent term         estimate std.error statistic  p.value
   &lt;chr&gt;     &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 Asia      (Intercept) -7.83e+ 2   4.83e+1  -16.2    1.22e-45
 2 Asia      pop          4.23e-11   2.04e-9    0.0207 9.83e- 1
 3 Asia      year         4.25e- 1   2.44e-2   17.4    1.13e-50
 4 Asia      gdpPercap    2.51e- 4   3.01e-5    8.34   1.31e-15
 5 Europe    (Intercept) -1.61e+ 2   2.28e+1   -7.09   7.44e-12
 6 Europe    pop         -8.18e- 9   7.80e-9   -1.05   2.95e- 1
 7 Europe    year         1.16e- 1   1.16e-2    9.96   8.88e-21
 8 Europe    gdpPercap    3.25e- 4   2.15e-5   15.2    2.21e-40
 9 Africa    (Intercept) -4.70e+ 2   3.39e+1  -13.9    2.17e-38
10 Africa    pop         -3.68e- 9   1.89e-8   -0.195  8.45e- 1
11 Africa    year         2.61e- 1   1.71e-2   15.2    1.07e-44
12 Africa    gdpPercap    1.12e- 3   1.01e-4   11.1    2.46e-26
13 Americas  (Intercept) -5.33e+ 2   4.10e+1  -13.0    6.40e-31
14 Americas  pop         -2.15e- 8   8.62e-9   -2.49   1.32e- 2
15 Americas  year         3.00e- 1   2.08e-2   14.4    3.79e-36
16 Americas  gdpPercap    6.75e- 4   7.15e-5    9.44   1.13e-18
17 Oceania   (Intercept) -2.10e+ 2   5.12e+1   -4.10   5.61e- 4
18 Oceania   pop          8.37e- 9   3.34e-8    0.251  8.05e- 1
19 Oceania   year         1.42e- 1   2.65e-2    5.34   3.19e- 5
20 Oceania   gdpPercap    2.03e- 4   8.47e-5    2.39   2.66e- 2</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.rebeccabarter\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="rlbarter/blog_comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->




</body></html>